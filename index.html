<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Admin ‚Äì The Blaze</title>
<style>
body{font-family:Arial;background:#0e0e0e;color:#fff;padding:20px}
section{border:1px solid #333;padding:15px;margin-bottom:20px}
button{margin:5px;padding:8px}
.accept{background:#2ea043;color:#fff}
.cancel{background:#d73a49;color:#fff}
.delete{background:#6e7681;color:#fff}
</style>
</head>
<body>

<h1>Panel Admin ‚Äì The Blaze Java 1.21</h1>
<p>#3 Parcelas</p>

<!-- LOGIN -->
<div id="login">
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Contrase√±a"><br><br>
  <button onclick="login()">Entrar</button>
</div>

<!-- PANEL -->
<div id="panel" style="display:none">

<section>
<h2>üî¥ Control de Postulaciones</h2>
<p id="estado"></p>
<button onclick="toggle()">Abrir / Cerrar postulaciones</button>
<button onclick="abrirPublica()">Abrir p√°gina postulaciones</button>
</section>

<section>
<h2>üì• Pendientes</h2>
<div id="pendientes"></div>
</section>

<section>
<h2>‚úÖ Aceptadas</h2>
<div id="aceptadas"></div>
</section>

<section>
<h2>‚ùå Canceladas</h2>
<div id="canceladas"></div>
</section>

<button onclick="logout()">Cerrar sesi√≥n</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://bvbneelfosacutwhjzhx.supabase.co",
  "sb_publishable_8QluYXwqMPxYWszgJlCbzw_EdakwSl-"
);

// üîê sesi√≥n
async function check(){
  const { data:{session} } = await supabase.auth.getSession();
  if(session){
    login.style.display="none";
    panel.style.display="block";
    cargarTodo();
  }
}
check();

window.login = async ()=>{
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if(!error) check();
};

// üîÑ cargar estado abierto/cerrado
async function cargarEstado(){
  const { data } = await supabase
    .from("config")
    .select("value")
    .eq("key","soporte_abierto")
    .single();

  estado.textContent = data.value
    ? "üü¢ Postulaciones ABIERTAS"
    : "üî¥ Postulaciones CERRADAS";
}

// üîÅ abrir / cerrar
window.toggle = async ()=>{
  const { data } = await supabase
    .from("config")
    .select("value")
    .eq("key","soporte_abierto")
    .single();

  await supabase
    .from("config")
    .update({ value: !data.value })
    .eq("key","soporte_abierto");

  cargarEstado();
};

// üìÇ cargar postulaciones
async function cargar(tipo, contenedor){
  const { data } = await supabase
    .from("postulaciones")
    .select("*")
    .eq("estado", tipo)
    .order("id",{ascending:false});

  contenedor.innerHTML="";
  data.forEach(p=>{
    contenedor.innerHTML += `
      <div>
        <b>${p.discord}</b>
        <button class="accept" onclick="cambiar(${p.id},'aceptada')">Aceptar</button>
        <button class="cancel" onclick="cambiar(${p.id},'cancelada')">Cancelar</button>
        ${tipo==="cancelada"
          ? `<button class="delete" onclick="borrar(${p.id})">Borrar</button>`
          : ""}
      </div>`;
  });
}

// üîÅ cambiar estado
window.cambiar = async (id, estado)=>{
  await supabase.from("postulaciones")
    .update({ estado })
    .eq("id",id);
  cargarTodo();
};

// üóëÔ∏è borrar
window.borrar = async id =>{
  await supabase.from("postulaciones")
    .delete()
    .eq("id",id);
  cargarTodo();
};

// üîÑ cargar todo
function cargarTodo(){
  cargarEstado();
  cargar("pendiente", pendientes);
  cargar("aceptada", aceptadas);
  cargar("cancelada", canceladas);
}

// üåê abrir p√°gina p√∫blica
window.abrirPublica = ()=>{
  window.open("postulaciones-blaze.html","_blank");
};

// üö™ logout
window.logout = async ()=>{
  await supabase.auth.signOut();
  location.reload();
};
</script>

</body>
</html>
