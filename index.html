<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Postulaciones ‚Äì The Blaze</title>

<style>
body{font-family:Arial;background:#0d0d0d;color:#fff;padding:20px}
section{border:1px solid #333;padding:15px;margin-bottom:20px}
button{margin:5px;padding:6px 10px;cursor:pointer}
.accept{background:#2ea043;color:white}
.cancel{background:#d73a49;color:white}
.delete{background:#6e7681;color:white}
.control{background:#5865f2;color:white}
</style>
</head>
<body>

<h1>Panel Postulaciones ‚Äì The Blaze Java 1.21</h1>
<p>#3 Parcelas</p>

<section>
<h2>‚öôÔ∏è Control</h2>
<p id="estado">Cargando...</p>
<button class="control" onclick="toggle()">Abrir / Cerrar postulaciones</button>
<button class="control" onclick="abrirPublica()">Abrir p√°gina postulaciones</button>
</section>

<section>
<h2>üì• Pendientes</h2>
<div id="pendientes"></div>
</section>

<section>
<h2>‚úÖ Aceptadas</h2>
<div id="aceptadas"></div>
</section>

<section>
<h2>‚ùå Canceladas</h2>
<div id="canceladas"></div>
</section>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://bvbneelfosacutwhjzhx.supabase.co",
  "sb_publishable_8QluYXwqMPxYWszgJlCbzw_EdakwSl-"
);

// ----- ESTADO ABIERTO / CERRADO -----
async function cargarEstado(){
  const { data } = await supabase
    .from("config")
    .select("value")
    .eq("key","soporte_abierto")
    .single();

  document.getElementById("estado").textContent =
    data.value ? "üü¢ Postulaciones ABIERTAS" : "üî¥ Postulaciones CERRADAS";
}

window.toggle = async ()=>{
  const { data } = await supabase
    .from("config")
    .select("value")
    .eq("key","soporte_abierto")
    .single();

  await supabase
    .from("config")
    .update({ value: !data.value })
    .eq("key","soporte_abierto");

  cargarEstado();
};

// ----- CARGAR POSTULACIONES -----
async function cargar(tipo, contenedor){
  const { data } = await supabase
    .from("postulaciones")
    .select("*")
    .eq("estado", tipo)
    .order("id",{ascending:false});

  contenedor.innerHTML = "";
  data.forEach(p=>{
    contenedor.innerHTML += `
      <div style="border-bottom:1px solid #333;padding:6px">
        <b>${p.discord}</b>
        ${tipo==="pendiente" ? `
          <button class="accept" onclick="cambiar(${p.id},'aceptada')">Aceptar</button>
          <button class="cancel" onclick="cambiar(${p.id},'cancelada')">Cancelar</button>
        ` : ""}
        ${tipo==="cancelada" ? `
          <button class="delete" onclick="borrar(${p.id})">Borrar</button>
        ` : ""}
      </div>
    `;
  });
}

window.cambiar = async (id, estado)=>{
  await supabase
    .from("postulaciones")
    .update({ estado })
    .eq("id",id);
  cargarTodo();
};

window.borrar = async id=>{
  await supabase
    .from("postulaciones")
    .delete()
    .eq("id",id);
  cargarTodo();
};

function cargarTodo(){
  cargarEstado();
  cargar("pendiente", document.getElementById("pendientes"));
  cargar("aceptada", document.getElementById("aceptadas"));
  cargar("cancelada", document.getElementById("canceladas"));
}

// ----- ABRIR P√ÅGINA P√öBLICA -----
window.abrirPublica = ()=>{
  window.open("postulaciones-blaze.html","_blank");
};

cargarTodo();
</script>

</body>
</html>
